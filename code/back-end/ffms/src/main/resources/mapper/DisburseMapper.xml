<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="org.csu.ffms.persistence.DisburseMapper">
    <insert id="newDisburse" parameterType="Disburse">
        INSERT INTO DISBURSE (AMOUNT_PAID,USERID,TIME,DESCRIPTION,TYPE)
        VALUES (-#{amount_paid},#{userId},#{time},#{description},#{type})
    </insert>
    
    <delete id="deleteDisburse" parameterType="int" >
        delete FROM DISBURSE WHERE DISBURSEID=#{disburseId}
    </delete>

    <update id="updateDisburse" parameterType="Disburse">
        UPDATE DISBURSE
        SET DISBURSEID = #{disburseId}
        <if test="amount_paid != null">
            ,AMOUNT_PAID = -#{amount_paid}
        </if>
        <if test="time != null">
            ,TIME = #{time}
        </if>
        <if test="description != null">
            ,DESCRIPTION = #{description}
        </if>
        <if test="type != null">
            ,TYPE = #{type}
        </if>
        WHERE DISBURSEID = #{disburseId}
    </update>
    
    <select id="findDisburseList" parameterType="Disburse" resultType="Disburse">
        SELECT *
        FROM DISBURSE
        WHERE 1=1
        <if test="userId != null">
            AND USERID IN (
                SELECT userid
                FROM relation
                WHERE
                FAMILYID = (
                  SELECT FAMILYID
                  FROM RELATION
                  WHERE USERID = #{userId}
            ))
        </if>
        <if test="time != null">
            AND TIME = #{time}
        </if>
        <if test="type != null">
            AND TYPE = #{type}
        </if>
    </select>

    <select id="findFamilyMember" parameterType="String" resultType="String">
        SELECT userid
        FROM relation
        WHERE
        FAMILYID = (
          SELECT FAMILYID
          FROM RELATION
          WHERE USERID = #{userId}
        )
    </select>

    <select id="findFamily" parameterType="String" resultType="String">
        SELECT FAMILYNAME
          FROM RELATION,FAMILY
          WHERE RELATION.FAMILYID = FAMILY.FAMILYID AND USERID = #{userId}
    </select>

    <select id="totalDisbursement" parameterType="Disburse" resultType="int">
        SELECT IFNULL(SUM(AMOUNT_PAID),0)
        FROM DISBURSE
        WHERE  USERID = #{userId} AND TIME =#{time,jdbcType=DATE}
    </select>


</mapper>